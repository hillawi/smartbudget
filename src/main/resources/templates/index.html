<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/html">
<head th:insert="~{fragments/general :: head}"></head>
<body class="">
<header th:insert="~{fragments/general :: header}"></header>

<div class="container border-5 text-center">
    <div class="row">
        <form action="#" th:action="@{/}" method="post">
            <div class="mb-3  rounded border border-secondary">
                <label for="months" class="form-label">Month</label>
                <select id="months" class="form-control text-center p-2 m-4" th:object="${transactionSearchForm}"
                        th:field="*{selectedMonth}">
                    <option value="">All</option>
                    <option th:each="month: ${months}" th:value="${month}" th:text="${month}"></option>
                </select>
                <label for="categories" class="form-label">Category</label>
                <select id="categories" class="form-control text-center p-2 m-4" th:object="${transactionSearchForm}"
                        th:field="*{selectedCategory}">
                    <option value="">All</option>
                    <option th:each="category: ${categories}" th:value="${category}" th:text="${category}"></option>
                </select>
                <button type="submit" class="btn btn-primary">Search</button>
            </div>
        </form>
    </div>

    <div class="row">
        <h2>Incomes (<span th:text="${incomesTotal}"></span>)</h2>
        <table class="table table-striped table-success">
            <thead th:insert="~{fragments/expenses-table :: fields}"></thead>
            <tbody th:replace="~{fragments/expenses-table :: tableBody(tableData=${incomes})}"></tbody>
        </table>

        <div>
            <canvas id="incomes-chart"></canvas>
        </div>
    </div>

    <div class="row">
        <h2>Expenses (<span th:text="${expensesTotal}"></span>)</h2>
        <table class="table table-striped table-warning">
            <thead th:insert="~{fragments/expenses-table :: fields}"></thead>
            <div th:replace="~{fragments/expenses-table :: tableBody(tableData=${expenses})}"></div>
        </table>
        <div>
            <canvas id="expenses-chart"></canvas>
        </div>
    </div>

    <div class="row">
        <div>
            <canvas id="expenses-categories-chart"></canvas>
        </div>
    </div>
</div>

<script th:inline="javascript">
    /*<![CDATA[*/
    const monthlyIncomes = /*[[${incomesPerMonth}]]*/ {};
    const incomesLabels = Object.keys(monthlyIncomes).sort(); // Get months and sort them
    const incomesData = incomesLabels.map(month => monthlyIncomes[month]);

    const incomesCtx = document.getElementById('incomes-chart');

    new Chart(incomesCtx, {
        type: 'bar',
        data: {
            labels: incomesLabels,
            datasets: [{
                label: 'Total incomes per month',
                data: incomesData,
                backgroundColor: [
                    '#D1E7DD'
                ],
                borderColor: [
                    '#729d8d'
                ],
                borderWidth: 1
            }]
        },
        options: {
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });

    const monthlyExpenses = /*[[${expensesPerMonth}]]*/ {};
    const expensesLabels = Object.keys(monthlyExpenses).sort(); // Get months and sort them
    const expensesData = expensesLabels.map(month => monthlyExpenses[month]);
    const expensesCtx = document.getElementById('expenses-chart');

    new Chart(expensesCtx, {
        type: 'bar',
        data: {
            labels: expensesLabels,
            datasets: [{
                label: 'Total expenses per month',
                data: expensesData,
                backgroundColor: [
                    '#FFF3CD'
                ],
                borderColor: [
                    '#b19c57'
                ],
                borderWidth: 1
            }]
        },
        options: {
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });

    const amountsPerCategory = /*[[${amountsPerCategory}]]*/ {};
    const amountsPerCategoryLabels = Object.keys(amountsPerCategory).sort();
    const amountsPerCategoryData = amountsPerCategoryLabels.map(month => amountsPerCategory[month]);
    const amountsPerCategoryCtx = document.getElementById('expenses-categories-chart');

    new Chart(amountsPerCategoryCtx, {
        type: 'polarArea',
        data: {
            labels: amountsPerCategoryLabels,
            datasets: [{
                label: 'Total expenses per month',
                data: amountsPerCategoryData,
                borderWidth: 1
            }]
        },
        options: {
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
    /*]]>*/
</script>

<footer th:insert="~{fragments/general :: footer}"></footer>
</body>
</html>